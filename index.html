<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-cache, no-store" />
  <style>
    body, h1, h2, h3, h4, h5, h6, hr, p, blockquote, dl, dt, dd, ul, ol, li, pre, form, fieldset, legend, button, input, textarea, th, td { margin:0; padding:0; } 
    body, button, input, select, textarea { font:12px/1.5tahoma, arial, \5b8b\4f53; } 
    h1, h2, h3, h4, h5, h6{ font-size:100%; } 
    address, cite, dfn, em, var { font-style:normal; } 
    code, kbd, pre, samp { font-family:couriernew, courier, monospace; } 
    small{ font-size:12px; } 
    ul, ol { list-style:none; } 
    a { text-decoration:none; } 
    a:hover { text-decoration:underline; } 
    sup { vertical-align:text-top; } 
    sub{ vertical-align:text-bottom; } 
    legend { color:#000; } 
    fieldset, img { border:0; } 
    button, input, select, textarea { font-size:100%; } 
    table { border-collapse:collapse; border-spacing:0; }
    .color-block{
      display: inline-block;
      width: 12px;
      height: 12px;
      cursor: pointer;
    }

  </style>
  <script src="/jquery"></script>
 
</head>
<body>
<div class="container">
    <div
      style="position: fixed; right: 0; top: 0;"
    >
      <div>
          <span id="colorblock1" class="color-block"></span>
          <span id="text1"></span>
      </div>
      <div>
          <span id="colorblock2" class="color-block"></span>
          <span id="text2"></span>
      </div>
      <div>
          <span id="colorblock3" class="color-block"></span>
          <span id="text3"></span>
      </div>
      <div>
          <span id="colorblock4" class="color-block"></span>
          <span id="text4"></span>
      </div>
      <div>
          <span id="colorblock5" class="color-block"></span>
          <span id="text5"></span>
      </div>
      <div>
          <span id="colorblock6" class="color-block"></span>
          <span id="text6"></span>
      </div>
      <button id="clearBtn">clear</button>
      <button id="playBtn">play</button>
      <button id="stopBtn">stop</button>
      <button id="getPoints">get points</button>
    </div>
    <canvas id="canva"></canvas>
    <video id="main-video" src="/video.mp4" controls>
    </video>
</div>
<script>
  let $canva, ctx, $video, setInter, px=[], py=[];
  const pointStatic = {
    dataClear: {"x":468,"y":648,},

  };
  const pointList = {
    okBtn: [{"x":431,"y":776,"pt":"45,196,180,255"},{"x":369,"y":798,"pt":"168,182,182,255"},{"x":338,"y":801,"pt":"216,255,255,255"},{"x":284,"y":788,"pt":"45,196,180,255"}],
    menuBtn: [{"x":672,"y":76,"pt":"244,248,248,255"},{"x":637,"y":71,"pt":"68,70,65,255"},{"x":659,"y":45,"pt":"77,72,69,255"},{"x":672,"y":29,"pt":"245,245,255,255"}],
    menuCancel: [{"x":280,"y":833,"pt":"232,53,80,255"},{"x":454,"y":844,"pt":"232,53,80,255"},{"x":351,"y":906,"pt":"239,240,240,255"},{"x":458,"y":801,"pt":"247,249,247,255"}],
    menuOkWithCancel: [{"x":443,"y":846,"pt":"232,53,80,255"},{"x":607,"y":832,"pt":"232,53,80,255"},{"x":298,"y":852,"pt":"254,255,254,255"},{"x":89,"y":840,"pt":"254,255,254,255"}],
    trailCancel: [{"x":615,"y":823,"pt":"45,196,180,255"},{"x":405,"y":823,"pt":"45,196,180,255"},{"x":285,"y":823,"pt":"232,53,80,255"},{"x":110,"y":821,"pt":"232,53,80,255"}],
    introHandle: [{"x":194,"y":1087,"pt":"200,38,35,255"},{"x":505,"y":1093,"pt":"200,38,35,255"},{"x":568,"y":1075,"pt":"110,11,2,255"},{"x":151,"y":1075,"pt":"110,11,2,255"}],
    helpboxClose: [{"x":289,"y":1203,"pt":"45,196,180,255"},{"x":436,"y":1209,"pt":"45,196,180,255"},{"x":356,"y":1225,"pt":"45,196,180,255"},{"x":362,"y":1173,"pt":"45,196,180,255"}],
    isPlaying: [{"x":168,"y":85,"pt":"132,213,46,255"},{"x":370,"y":85,"pt":"132,213,48,255"},{"x":588,"y":84,"pt":"132,213,48,255"},{"x":165,"y":75,"pt":"251,250,248,255"},{"x":369,"y":76,"pt":"255,255,255,255"},{"x":577,"y":75,"pt":"248,249,255,255"}],
    
  };
  function checkSth(ctxtar, pts, result, diff=16){
    // console.log('checking');
    const pass = pts.every( item => {
      let myImageData = ctx.getImageData(item.x, item.y, 1, 1).data;
      const ptarr = item.pt.split(",");
      return ptarr.every((item2,idx2) => Math.abs(item2 - myImageData[idx2]) <= diff)
    });
    if (pass) {
      console.log(result);
    }
  }
  function play(){
    document.querySelector('#main-video').play();
  }
  function stop(){
    document.querySelector('#main-video').pause();
  }
  function clear(){
    console.log('clear');
    px=[];
    py=[];
    for(let i =1;i<7;i++){
      $(`#text${i}`).text('');
      $(`#colorblock${i}`)[0].style.backgroundColor = `#fff`;
    }
  }
  
  
  function renderCanvas () {
    $canva =$('#canva');
    $video = $("#main-video");
    ctx = $canva[0].getContext('2d');
    let intervalOn = false;
    console.log($video.width(),$video.height())

    function render () {
      ctx.drawImage($video[0], 0, 0, $video.width(), $video.height());
      checkSth(ctx, pointList.okBtn, 'ok found');
      checkSth(ctx, pointList.menuBtn, 'menu found');
      checkSth(ctx, pointList.menuOkWithCancel, 'menuOkWithCancel found');
      if(px.length){
        updatePoint();
      }
    }


    $canva[0].width = $video.width();
    $canva[0].style.width = $video.width();
    $canva[0].height = $video.height();
    $canva[0].style.height = $video.height();
    $video[0].play();
    $canva[0].addEventListener('click', (e)=>{
      if(px.length < 6){
        px.push(e.pageX);
        py.push(e.pageY);
        updatePoint();
      }
      // $('#text')[0].style.color = `rgba(${revertColor(myImageData.data)})`;
    });
    render();
    $('#clearBtn')[0].addEventListener('click', clear);
    $('#playBtn')[0].addEventListener('click', play);
    $('#stopBtn')[0].addEventListener('click', stop);
    $('#getPoints')[0].addEventListener('click', () => {
      console.log( JSON.stringify(
        px.map((item, idx) => {
          let myImageData = ctx.getImageData(px[idx], py[idx], 1, 1);
          return {
            x: px[idx],
            y: py[idx],
            pt: myImageData.data.join(','),
          }
        })
      ))
    });

    for(let i =1;i<7;i++){
      $(`#colorblock${i}`)[0].addEventListener('click', (e) => remove(i));
    }
    setInter = setInterval(r => {
      intervalOn && render();
    }, 120)

    
    function updatePoint () {
      px.forEach((item, idx) => {
        let myImageData = ctx.getImageData(px[idx], py[idx], 1, 1);
        $(`#text${idx+1}`).text(px[idx] + ',' + py[idx] + ' | ' + myImageData.data.join(','));
        $(`#colorblock${idx+1}`)[0].style.backgroundColor = `rgba(${myImageData.data.join(',')})`;
      })
    }
    function remove(val){
      console.log('clear', val);
      px.splice(val-1, 1);
      py.splice(val-1, 1);
      for(let i =1;i<7;i++){
        $(`#text${i}`).text('');
        $(`#colorblock${i}`)[0].style.backgroundColor = `#fff`;
      }
      if(px.length){
        updatePoint();
      }
    }
    $video[0].addEventListener('play', function () {
      intervalOn = true;
    });

    // 视频播放结束
    $video[0].addEventListener('ended', function () {
      intervalOn = false;
    });

    // 视频被暂停
    $video[0].addEventListener('pause', function () {
      // intervalOn = false;
    });
  }
  $(($)=>{
    document.querySelector('#main-video').addEventListener('canplay', () => {
      renderCanvas();
    }, {once: true}); 
  })
  function revertColor(arr){
    return [255-arr[0], 255-arr[1], 255-arr[2], 255].join(',');
  }
</script>
</body>
</html>
　　